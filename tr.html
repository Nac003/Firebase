<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <title>Firebase Transakcije i ≈†tednja</title>
</head>
<body>
  <h2>Dodaj transakciju</h2>

  <form id="transakcija-form">
    <label>Kategorija:</label><br>
    <input type="text" id="kategorija" required><br><br>

    <label>Iznos:</label><br>
    <input type="number" id="iznos" required><br><br>

    <label>Tip transakcije:</label><br>
    <select id="tip">
      <option value="trosak">Tro≈°ak</option>
      <option value="prihod">Prihod</option>
    </select><br><br>

    <button type="submit">Spremi transakciju</button>
  </form>

  <hr>

  <h3>‚úÖ Logirane transakcije:</h3>
  <div id="logs"></div>

  <h3>üë§ Aktivnosti korisnika:</h3>
  <div id="activity"></div>

  <h3>üí∞ Stanje ≈°tednje:</h3>
  <div id="stednja">Uƒçitavam...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAlCyHgTglR1xh9GwhIhxoNh0POwXdINzE",
      authDomain: "natalia-ignac-danijela.firebaseapp.com",
      databaseURL: "https://natalia-ignac-danijela-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "natalia-ignac-danijela",
      storageBucket: "natalia-ignac-danijela.firebasestorage.app",
      messagingSenderId: "562828177333",
      appId: "1:562828177333:web:89ab5165fc7bfcd63e33fc",
      measurementId: "G-72Z5HZ8M4M"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const userId = "demoUser123"; // za test, kasnije zamijeni s auth.currentUser.uid

    // ------------------ Transaction Log funkcija (log)
    function logTransaction(action, details, userId) {
      const logRef = ref(db, "transaction_log"); // Transaction Log
      const newLog = push(logRef);
      const logData = {
        datum: new Date().toISOString(),
        tip_transakcije: action,
        id_korisnika: userId,
        kategorija: details.kategorija,
        iznos: details.iznos
      };
      set(newLog, logData);
    }

    // ------------------ User Activity funkcija (log)
    function logUserActivity(userId, activityType, description) {
      const activityRef = ref(db, "user_activity"); // User Activity
      const newActivity = push(activityRef);
      const activityData = {
        id_korisnika: userId,
        aktivnost: activityType,
        detalji: description,
        vrijeme: new Date().toISOString()
      };
      set(newActivity, activityData);
    }

    // ------------------ Trigger funkcija: dodavanje ≈°tednje (ako prihod u kategoriji sadr≈æi "≈°tednja")
    async function dodajStednju(userId, kategorija, iznos) {
      const stednjaRef = ref(db, "stednja");
      const q = query(stednjaRef, orderByChild("id_korisnika"), equalTo(userId));
      const snapshot = await get(q);

      let idStednje;
      let trenutno = 0;

      if (snapshot.exists()) {
        const key = Object.keys(snapshot.val())[0];
        idStednje = key;
        trenutno = snapshot.val()[key].iznos;
      } else {
        const newRef = push(stednjaRef);
        idStednje = newRef.key;
      }

      trenutno += iznos;

      const newData = {
        id_stednje: idStednje,
        id_korisnika: userId,
        iznos: trenutno,
        datum: new Date().toISOString()
      };

      await set(ref(db, `stednja/${idStednje}`), newData);
      document.getElementById("stednja").innerText = `${trenutno.toFixed(2)} ‚Ç¨`;
      logUserActivity(userId, "a≈æuriranje ≈°tednje", `Novo stanje ≈°tednje: ${trenutno.toFixed(2)} ‚Ç¨`); // user activity

      // Dodaj transakciju i log u transaction log
      const transRef = ref(db, "budget_korisnika"); // Transaction
      const newTransRef = push(transRef);
      const transData = {
        id_korisnika: userId,
        datum_transakcije: new Date().toISOString().split("T")[0],
        kategorija: kategorija,
        iznos: iznos,
        tip_transakcije: "uplata_stednje",
        id_stednje: idStednje
      };
      await set(newTransRef, transData);

      const logRef = ref(db, "transaction_log"); // Transaction log
      const noviLog = push(logRef);
      await set(noviLog, {
        id_korisnika: userId,
        id_stednje: idStednje,
        iznos: iznos,
        kategorija: kategorija,
        tip_transakcije: "uplata_stednje",
        datum: new Date().toISOString()
      });
    }

    // ------------------ Submit forma
    const form = document.getElementById("transakcija-form");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const kategorija = document.getElementById("kategorija").value;
      const iznos = parseFloat(document.getElementById("iznos").value);
      const tip = document.getElementById("tip").value;

      // Trigger logika: prihod koji ide u ≈°tednju
      if (tip === "prihod" && kategorija.toLowerCase().includes("≈°tednja")) {
        await dodajStednju(userId, kategorija, iznos); // trigger
      } else {
        // Transaction log: obiƒçna transakcija
        const transRef = ref(db, "budget_korisnika");
        const newTrans = push(transRef);
        const transData = {
          id_korisnika: userId,
          datum_transakcije: new Date().toISOString().split("T")[0],
          kategorija: kategorija,
          iznos: iznos,
          tip_transakcije: tip
        };
        await set(newTrans, transData);

        logTransaction(tip, transData, userId); // transaction log
        logUserActivity(userId, "dodavanje", `Dodana nova transakcija (${tip}): ${kategorija} - ${iznos}‚Ç¨`); // user activity
      }

      form.reset();
    });

    // ------------------ Prikaz logiranih transakcija (transaction log)
    const logsDiv = document.getElementById("logs");
    const logRef = ref(db, "transaction_log");
    onValue(logRef, snapshot => {
      const data = snapshot.val();
      logsDiv.innerHTML = "";
      if (data) {
        Object.keys(data).forEach(key => {
          const log = data[key];
          logsDiv.innerHTML += `
            <div style="border:1px solid #ccc; padding:10px; margin:5px;">
              <strong>${log.tip_transakcije}</strong> | ${log.kategorija} (${log.iznos} ‚Ç¨)<br>
              Datum: ${log.datum}
            </div>
          `;
        });
      } else {
        logsDiv.innerHTML = "<p>Nema logiranih transakcija jo≈°.</p>";
      }
    });

    // ------------------ Prikaz aktivnosti korisnika (user activity)
    const activityDiv = document.getElementById("activity");
    const activityRef = ref(db, "user_activity");
    onValue(activityRef, snapshot => {
      const data = snapshot.val();
      activityDiv.innerHTML = "";
      if (data) {
        Object.keys(data).forEach(key => {
          const act = data[key];
          activityDiv.innerHTML += `
            <div style="border:1px solid #ccc; padding:10px; margin:5px;">
              <strong>${act.aktivnost}</strong> | ${act.detalji}<br>
              Vrijeme: ${act.vrijeme}
            </div>
          `;
        });
      } else {
        activityDiv.innerHTML = "<p>Nema aktivnosti jo≈°.</p>";
      }
    });

    // ------------------ Prikaz trenutne ≈°tednje
    const stednjaDiv = document.getElementById("stednja");
    const stednjaRef = ref(db, "stednja");
    onValue(stednjaRef, snapshot => {
      let ukupno = 0;
      if (snapshot.exists()) {
        const data = snapshot.val();
        Object.keys(data).forEach(key => {
          if (data[key].id_korisnika === userId) {
            ukupno = data[key].iznos;
          }
        });
      }
      stednjaDiv.innerText = `${ukupno.toFixed(2)} ‚Ç¨`;
    });
  </script>
</body>
</html>
